<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>شبیه‌ساز هوش مصنوعی انسان‌نما ۲.۱</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Vazirmatn', sans-serif;
            background: radial-gradient(ellipse at bottom, #1b2735 0%, #090a0f 100%);
        }
        /* انیمیشن برای درخشش و نبض */
        @keyframes pulse-glow {
            0%, 100% {
                box-shadow: 0 0 8px #3b82f6, 0 0 12px #3b82f6;
                transform: scale(1);
            }
            50% {
                box-shadow: 0 0 16px #60a5fa, 0 0 24px #60a5fa;
                transform: scale(1.05);
            }
        }
        .pulse-glow-button {
            animation: pulse-glow 2.5s infinite ease-in-out;
        }
        /* انیمیشن برای نقطه‌های در حال فکر کردن */
        @keyframes thinking-dots {
            0%, 20% { content: '.'; }
            40%, 60% { content: '..'; }
            80%, 100% { content: '...'; }
        }
        .thinking::after {
            content: '.';
            animation: thinking-dots 1.5s infinite;
            display: inline-block;
            width: 20px;
            text-align: left;
        }
    </style>
</head>
<body class="text-gray-200 flex flex-col items-center justify-center min-h-screen p-4 overflow-hidden">

    <!-- نوار اعلان -->
    <div id="notification" class="fixed top-0 left-0 right-0 bg-red-600 text-white text-center p-3 transform -translate-y-full transition-transform duration-500 z-50">
        <p id="notification-text"></p>
    </div>

    <div class="w-full max-w-6xl bg-black bg-opacity-30 backdrop-blur-sm rounded-2xl shadow-2xl border border-blue-500/30 p-4 md:p-8 space-y-6">
        <div class="text-center mb-4">
            <h1 class="text-3xl md:text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-500">شبیه‌ساز هوش مصنوعی انسان‌نما</h1>
            <p class="text-gray-400 mt-2">می‌توانم محیط را ببینم یا در وب "جستجو" کنم. با من صحبت کنید.</p>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- ستون چپ: دوربین و کنترل‌ها -->
            <div class="flex flex-col space-y-4">
                <div class="relative w-full aspect-video bg-black rounded-lg overflow-hidden border-2 border-blue-500/50 shadow-lg">
                    <video id="webcam" class="w-full h-full object-cover" autoplay playsinline muted></video>
                    <canvas id="canvas" class="hidden"></canvas>
                    <div id="loading-overlay" class="absolute inset-0 bg-black bg-opacity-70 flex-col items-center justify-center hidden z-10">
                         <div class="w-16 h-16 border-4 border-dashed rounded-full animate-spin border-blue-400"></div>
                         <p id="loading-text" class="mt-4 text-lg">در حال پردازش...</p>
                    </div>
                </div>
                <div class="flex flex-col items-center justify-center gap-4">
                    <button id="startButton" class="w-full md:w-auto bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-full transition-all duration-300 shadow-lg">
                        فعال‌سازی سیستم
                    </button>
                    <div id="status" class="text-center p-3 rounded-lg bg-gray-800/50 text-yellow-300 min-w-[250px] border border-gray-700">
                        وضعیت: آماده‌سازی
                    </div>
                </div>
            </div>

            <!-- ستون راست: گفتگو -->
            <div class="bg-gray-800/50 p-4 rounded-lg border border-gray-700 flex flex-col space-y-4">
                <div>
                    <h2 class="text-lg font-semibold text-blue-300 mb-2">ورودی شما (صدا):</h2>
                    <p id="user-text" class="text-gray-300 min-h-[50px] bg-black/20 p-3 rounded">...</p>
                </div>
                <div>
                    <h2 class="text-lg font-semibold text-green-300 mb-2">پاسخ هوش مصنوعی:</h2>
                    <p id="ai-response" class="text-gray-200 min-h-[100px] bg-black/20 p-3 rounded">...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        const startButton = document.getElementById('startButton');
        const webcamVideo = document.getElementById('webcam');
        const canvas = document.getElementById('canvas');
        const statusDiv = document.getElementById('status');
        const userTextDiv = document.getElementById('user-text');
        const aiResponseDiv = document.getElementById('ai-response');
        const loadingOverlay = document.getElementById('loading-overlay');
        const loadingText = document.getElementById('loading-text');
        const notification = document.getElementById('notification');
        const notificationText = document.getElementById('notification-text');

        let isListening = false;
        let mediaStream = null;
        let recognition;

        function showNotification(message, isError = true) {
            notificationText.textContent = message;
            notification.className = `fixed top-0 left-0 right-0 text-white text-center p-3 transform transition-transform duration-500 z-50 ${isError ? 'bg-red-600' : 'bg-blue-600'}`;
            notification.style.transform = 'translateY(0)';
            setTimeout(() => {
                notification.style.transform = 'translateY(-100%)';
            }, 4000);
        }

        try {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.lang = 'fa-IR';
            recognition.interimResults = false;
        } catch (e) {
            showNotification('مرورگر شما از تشخیص گفتار پشتیبانی نمی‌کند.');
            startButton.disabled = true;
        }
        
        async function startSystem() {
            if (isListening) return;
            try {
                mediaStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                webcamVideo.srcObject = mediaStream;
                webcamVideo.onloadedmetadata = () => {
                     webcamVideo.play();
                     statusDiv.textContent = 'سیستم فعال شد. صحبت کنید.';
                     startButton.textContent = 'در حال شنیدن...';
                     startButton.classList.add('pulse-glow-button');
                     isListening = true;
                     recognition.start();
                };
            } catch (err) {
                console.error("خطا در دسترسی به دوربین/میکروفون:", err);
                showNotification('لطفاً اجازه دسترسی به دوربین و میکروفون را بدهید.');
            }
        }

        function captureFrame() {
            canvas.width = webcamVideo.videoWidth;
            canvas.height = webcamVideo.videoHeight;
            const context = canvas.getContext('2d');
            context.drawImage(webcamVideo, 0, 0, canvas.width, canvas.height);
            return canvas.toDataURL('image/jpeg', 0.8).split(',')[1];
        }

        startButton.addEventListener('click', startSystem);

        recognition.onresult = (event) => {
            const transcript = event.results[0][0].transcript;
            userTextDiv.textContent = transcript;
            aiResponseDiv.textContent = '';
            aiResponseDiv.classList.add('thinking');
            loadingOverlay.classList.remove('hidden');
            loadingOverlay.classList.add('flex');

            const newsKeywords = ['خبر', 'اخبار', 'bbc', 'تازه ها', 'دنیا چه خبر'];
            const isNewsQuery = newsKeywords.some(keyword => transcript.includes(keyword));

            if (isNewsQuery) {
                statusDiv.textContent = 'در حال جستجو در وب...';
                loadingText.textContent = 'در حال جستجو در وب...';
                callGeminiAPI(transcript, null); // عدم ارسال تصویر برای درخواست خبری
            } else {
                statusDiv.textContent = 'در حال تحلیل تصویر...';
                loadingText.textContent = 'در حال تحلیل تصویر...';
                const imageBase64 = captureFrame();
                callGeminiAPI(transcript, imageBase64);
            }
        };

        recognition.onend = () => {
            if (isListening) {
                try { recognition.start(); } catch(e) { /* جلوگیری از خطا */ }
            }
        };
        
        recognition.onerror = (event) => {
            console.error("خطای تشخیص گفتار:", event.error);
            if(event.error !== 'no-speech' && event.error !== 'aborted') {
                showNotification(`خطای میکروفون: ${event.error}`);
            }
        };

        async function callGeminiAPI(text, imageBase64) {
            const apiKey = ""; 
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
            
            let payload;
            if (imageBase64) {
                // Payload برای درخواست چندوجهی (تصویر + متن)
                payload = {
                    contents: [{
                        role: "user",
                        parts: [
                            { text: `شما یک هوش مصنوعی انسان‌نما، هوشمند و کمی شوخ طبع هستید. به این تصویر نگاه کن و به سوال کاربر به زبان فارسی پاسخ بده. سوال: "${text}"` },
                            { inlineData: { mimeType: "image/jpeg", data: imageBase64 } }
                        ]
                    }]
                };
            } else {
                // Payload برای درخواست خبری (فقط متن)
                payload = {
                    contents: [{
                        role: "user",
                        parts: [
                            { text: `شما یک هوش مصنوعی هستید که به اینترنت دسترسی دارید. به عنوان یک خبرنگار هوشمند، خلاصه‌ای از مهم‌ترین اخبار جهان در چند روز اخیر را، انگار که از منابع معتبری مانند BBC Persian خوانده‌اید، به زبان فارسی ارائه دهید. سوال کاربر این بود: "${text}"` }
                        ]
                    }]
                };
            }

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorBody = await response.json();
                    console.error('API Error Body:', errorBody);
                    throw new Error(`خطای شبکه: ${response.status} ${response.statusText}`);
                }

                const result = await response.json();
                let aiText = "متاسفانه در حال حاضر نمی‌توانم پاسخ دهم. لطفاً دوباره تلاش کنید.";
                if (result.candidates && result.candidates[0]?.content?.parts[0]?.text) {
                    aiText = result.candidates[0].content.parts[0].text;
                }
                
                aiResponseDiv.textContent = aiText;
                speak(aiText);

            } catch (error) {
                console.error("خطا در ارتباط با Gemini API:", error);
                aiResponseDiv.textContent = "یک مشکل در ارتباط با سرور هوش مصنوعی به وجود آمد. لطفاً اتصال اینترنت خود را بررسی کنید.";
                showNotification(error.message);
            } finally {
                statusDiv.textContent = 'آماده دریافت فرمان بعدی';
                loadingOverlay.classList.add('hidden');
                loadingOverlay.classList.remove('flex');
                aiResponseDiv.classList.remove('thinking');
            }
        }

        function speak(text) {
            window.speechSynthesis.cancel();
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'fa-IR';
            utterance.rate = 1;
            window.speechSynthesis.speak(utterance);
        }
    </script>
</body>
</html>
